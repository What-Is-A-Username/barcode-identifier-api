version: '3'

services:
  barrel_db:
    image: postgres
    container_name: barrel_db
    env_file: .env
    restart: always
    volumes:
      - postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready"]
      interval: 10s
      timeout: 10s
      retries: 5

  barrel:
    image: willh12/barrel-dev:barrel-$BARREL_VERSION
    container_name: barrel
    env_file: .env
    restart: always
    environment:
      - DB_HOST=barrel_db
      - DB_PORT=5432
    depends_on:
      barrel_db:
        condition: service_healthy
    volumes:
      - "static-data:/vol/static"
      - "var-data:/var/data"
    command: >
      sh -c "whoami && ls -lha /vol/static && /barrel/scripts/run.sh"

  barrel_rabbitmq:
    image: bitnami/rabbitmq:latest
    container_name: barrel_rabbitmq
    env_file: .env
    restart: always
    healthcheck:
      test: rabbitmq-diagnostics -q ping 
      interval: 10s
      timeout: 10s
      retries: 12

  celery_worker:
    image: willh12/barrel-dev:celery_worker-$BARREL_VERSION
    container_name: barrel_celery_worker
    env_file: .env
    restart: always
    environment:
      - DB_HOST=barrel_db
      - DB_PORT=5432
    volumes:
      - "var-data:/var/data/"
      - "static-data:/vol/static/"
    command: >
      sh -c "celery_run.sh"
    depends_on:
      barrel_rabbitmq:
        condition: service_healthy
      barrel_db:
        condition: service_healthy

  barrel_proxy:
    container_name: barrel_proxy
    env_file: .env
    restart: always
    build:
      context: ./proxy
      args:
      - CONF_FILE=$CONF_FILE
      - SSL_SERVER_CERT_PATH=$SSL_SERVER_CERT_PATH
      - SSL_PRIVATE_KEY_PATH=$SSL_PRIVATE_KEY_PATH
    depends_on:
      - barrel
    ports:
      - $EXPOSED_PORT:80
      - $SECURE_PORT:443
    volumes:
      - static-data:/vol/static
      - ./proxy/frontend:/frontend
      - ./proxy/docs:/docs

volumes:
  postgres-data:
  static-data:
  var-data:
